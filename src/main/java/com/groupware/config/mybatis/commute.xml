<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.groupware.commute.dao.CommuteDao">
  
	<update id="punchIn" parameterType="CommuteDto">
	merge into cmt_tb
		using dual
		on (
			trunc(sysdate, 'dd') = trunc(cmt_str_tm, 'dd')
			and stf_sq = #{stf_sq}
			)
		when not matched then
			insert (cmt_sq, stf_sq, cmt_str_tm, cmt_msg)
			values (cmt_tb_cmt_sq.nextval, #{stf_sq}, sysdate, #{cmt_msg})
	</update>

	<update id="punchOut" parameterType="CommuteDto">
	merge into cmt_tb c
		using (
				select max(cmt_sq) cmt_sq
				from cmt_tb
				where stf_sq = #{stf_sq}
				and cmt_end_tm is null
		      )sub
		on (
			c.cmt_sq = sub.cmt_sq
			)
		when matched then
			update
			set c.cmt_end_tm = sysdate
			<if test="cmt_msg != null and cmt_msg != ''">
			, c.cmt_msg = c.cmt_msg || #{cmt_msg}
			</if>
			where c.cmt_sq = sub.cmt_sq
	</update>
	
	<select id="getCommuteList" parameterType="map" resultType="CommuteDto">
	select cmt_sq, stf_sq, cmt_str_tm, cmt_end_tm, cmt_msg, a.days, b.dt, to_char(trunc(b.dt, 'dd'), 'mm.dd') || '(' ||to_char(b.dt, 'dy')|| ')' cmt_dt
	from
	    (
	        select cmt_sq, stf_sq, cmt_str_tm, cmt_end_tm, cmt_msg, trunc(cmt.cmt_str_tm, 'dd') days
	        from cmt_tb cmt
	        where stf_sq = #{stf_sq}
	    ) a,
	    (   
   			<choose>
   				<when test="startDate != null and startDate != ''">
   				select trunc(to_date(#{startDate}), 'dd')+level-1 dt
   				</when>
	        	<otherwise>
	        	select trunc(sysdate, 'MM')+level-1 dt
	        	</otherwise>
	        </choose>
	        from dual
   			<choose>
   				<when test="startDate != null and startDate != ''">
   				connect by level &lt;= to_date(#{endDate})-trunc(to_date(#{startDate}), 'dd')+1
   				</when>
	        	<otherwise>
	        	connect by level &lt;= last_day(sysdate)-trunc(sysdate, 'MM')+1
	        	</otherwise>
	        </choose>
	    ) b
	where a.days(+) = b.dt
	order by b.dt
	</select>
	  
	<select id="getCommuteListDepartment" parameterType="map" resultType="map">
	select stf_nm, cmt_str_tm, cmt_end_tm, cmt_msg
	from
		(
		select sub.stf_nm, c.cmt_str_tm, c.cmt_end_tm, c.cmt_msg, to_char(c.cmt_str_tm, 'yy/mm/dd') dd
		from 
			cmt_tb c,
		    (
			    select s.stf_sq, s.stf_nm, r.rnk_nm, d.dpt_nm
			    from stf_tb s, dpt_div_tb d, rnk_tb r
			    where s.dpt_sq = d.dpt_sq
			    and s.dpt_sq = #{dpt_sq}
			    and s.rnk_sq = r.rnk_sq
		    )sub
		where c.stf_sq(+) = sub.stf_sq
		)l,
		(
		<choose>
			<when test="searchDate != null and searchDate != ''">
				select to_char(to_date(#{searchDate}), 'yy/mm/dd') dd
			</when>
			<otherwise>
				select to_char(sysdate, 'yy/mm/dd') dd
			</otherwise>
		</choose>
			from dual
		)r
	where l.dd = r.dd
	or l.dd is null
	</select>
</mapper>
  